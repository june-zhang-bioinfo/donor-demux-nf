// nextflow.config

// --- 1. Global Parameters ---
params {
    outdir = 'results'
    demux_outdir = "results/demuxalot"

    // Use absolute paths to SIF files to ensure HPC worker nodes find them
    donor_demux_image = 'donor_demux.sif'
    r_eval_image      = 'r_eval.sif'
}

// --- 2. Default Process Configuration ---
process {
    cpus = 1
    memory = '4 GB'
    time = '2h'

    errorStrategy = 'retry'
    maxRetries = 2

    // Default container for all processes
    container = params.donor_demux_image
}

// --- 3. Container Settings ---
docker {
    enabled = false
}

// --- 4. Profiles ---
profiles {

    local {
        executor = 'local'
        process {
            cpus = 2
            memory = '6 GB'
            time = '1h'
        }
    }

    hpc {
        singularity.enabled = true
        singularity.autoMounts = true
        singularity.cacheDir = "${baseDir}/containers"
        
        process {
            executor = 'slurm'
            queue = 'normal'
            
            // Critical: Loads singularity and disables Dynatrace injection
            beforeScript = 'module load singularity; export ONEAGENT_DISABLE_AUTO_INJECTION=1'

            cpus = 4
            memory = '16 GB'
            time = '04:00:00'

            errorStrategy = 'retry'
            maxRetries = 2

            clusterOptions = '--error=logs/nf-%j.err --output=logs/nf-%j.out'

            // --- Centralized Output Logic ---
            withName: '.*DEMUXALOT' {
                container = params.donor_demux_image
                cpus   = 8
                memory = '64 GB'
                time   = '12:00:00'
                publishDir = [
                    path: { "${params.demux_outdir}/${task.tag}" },
                    mode: 'copy',
                    pattern: '*.csv',
                    overwrite: true
                ]
            }

            withName: '.*R_SEURAT_ANALYSIS' {
                container = params.r_eval_image
                publishDir = [
                    path: { "${params.demux_outdir}/${task.tag}" },
                    mode: 'copy',
                    pattern: '*.pdf',
                    overwrite: true
                ]
            }

            // --- Process Specific Overrides ---
            withName: FREEBAYES_CALL {
                cpus = 8
                memory = '32 GB'
                time = '08:00:00'
                queue = 'bigmem'
                publishDir = [
                    path: { "${params.demux_outdir}/${task.tag}" },
                    mode: 'copy',
                    pattern: "freebayes/filtered.vcf",
                    saveAs: { filename -> "filtered.vcf" },
                    overwrite: true
    ]
            }

            // Add this inside the hpc profile -> process block
            withName: '.*CHANGE_READ_GROUP' {
                container = params.donor_demux_image
                cpus   = 4
                memory = '24 GB'  // Increased to prevent "Aborted" errors during write
                time   = '03:00:00'
            }
        } // End process
    } // End hpc
} // End profiles