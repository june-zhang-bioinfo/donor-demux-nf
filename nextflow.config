// nextflow.config

// --- 1. Global Parameters ---
params {
    outdir = 'results'

    // Container images (can be overridden by profiles)
    donor_demux_image = 'devjune26/donor_demux:1.0'
    r_eval_image      = 'devjune26/r_eval:1.0'
}

// --- 2. Default Process Configuration ---
process {
    cpus = 1
    memory = '4 GB'
    time = '2h'

    errorStrategy = 'retry'
    maxRetries = 2

    withName('*') {
        container = params.donor_demux_image
    }

    withName: R_SEURAT_ANALYSIS {
        container = params.r_eval_image
        cpus = 1
        memory = '8 GB'
    }
}

// --- 3. Container Settings ---
docker {
    enabled = true
    runOptions = '-u \$(id -u):\$(id -g)'
}

// --- 4. Profiles ---
profiles {

    // 4.1 Local / demo testing
    local {
        executor = 'local'
        process {
            cpus = 2
            memory = '6 GB'
            time = '1h'
        }
    }

    // 4.2 HPC / Slurm cluster
    hpc {
        executor = 'slurm'
        queue = 'short'

        process {
            cpus = 4
            memory = '16 GB'
            time = '4h'

            // Retry on failure
            errorStrategy = 'retry'
            maxRetries = 2

            // Slurm log files (ensure logs directory exists)
            clusterOptions = '--error=logs/nf-%j.err --output=logs/nf-%j.out'
        }

        // Heavy VCF calling step
        withName: FREEBAYES_CALL {
            cpus = 8
            memory = '32 GB'
            time = '12h'
            queue = 'high_mem'
        }

        // R analysis step
        withName: R_SEURAT_ANALYSIS {
            cpus = 1
            memory = '16 GB'
        }
    }
}
